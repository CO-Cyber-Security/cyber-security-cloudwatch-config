---
groups:
- name: concourse-heartbeat
  jobs:
  - concourse-heartbeat-fail
  - concourse-heartbeat-pass

heartbeat_image_resource: &heartbeat_image_resource
  type: docker-image
  source:
    repository: ubuntu
    tag: '18.04'

health_status_notify: &health_status_notify
  put: health-notification

heartbeat_pass_task: &heartbeat_pass_task
  platform: linux
  image_resource: *heartbeat_image_resource
  run:
    path: sh
    args:
    - -eu
    - -c
    - |
      set -x
      echo "Testing concourse reporting: success"

heartbeat_fail_task: &heartbeat_fail_task
  platform: linux
  image_resource: *heartbeat_image_resource
  run:
    path: sh
    args:
    - -eu
    - -c
    - |
      set -x
      echo "Testing concourse reporting: failure"
      exit(1)

resource_types:
  - name: http-api
    type: docker-image
    source:
      repository: aequitas/http-api-resource
      tag: latest

resources:
  - name: every_hour
    type: time
    source: {interval: 1h}

  - name: health-notification
    type: http-api
    source:
      uri: https://((health_host_test))/?alert_type=concourse$&alert_name=health
      method: POST
      headers:
        Authorization: "Bearer ((health_token_test))"
      json:
        service: "{service}"
        state: "{health}"
        message: "{message}"
        pipeline: "{BUILD_PIPELINE_NAME}"
        job: "{BUILD_JOB_NAME}"
        build_number: "{BUILD_NAME}"
      service: "Concourse"


jobs:
- name: concourse-heartbeat-pass
  plan:
  - get: every_hour
    trigger: true
  - task: heartbeat
    config:
      <<: *heartbeat_pass_task

    on_success:
      <<: *health_status_notify
      params:
        message: "Pipeline completed successfully"
        health: healthy

    on_failure:
      <<: *health_status_notify
      params:
        message: "Pipeline failed"
        health: unhealthy

- name: concourse-heartbeat-fail
  plan:
  - get: every_hour
    trigger: true
  - task: heartbeat
    config:
      <<: *heartbeat_fail_task

    on_success:
      <<: *health_status_notify
      params:
        message: "Pipeline completed successfully but should fail"
        health: unhealthy

    on_failure:
      <<: *health_status_notify
      params:
        message: "Pipeline failed and should fail"
        health: healthy

