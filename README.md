# Cyber Security CloudWatch Config

The aim of this repository is to automate the generation of CloudWatch
alarm config.

This repository uses `cloudwatch list-metrics` to identify resources to be monitored, queries the tags for those resources in order to classify them into services and environments.

The aim is to produce a set of `tfvar` files containing lists of maps
containing the config for the standard modules.

We specify a list of metrics we are interested in [metric-settings.json](lambda/health_package/metric-settings.json).

When we find a metric in an account that matches our settings an
appropriate alarm threshold is generated based on recent data and
that defines a var file which is passed to the terraform to create
the alarms.

The pipeline runs once per day to redefine new alarms and thresholds.

If new resources have been added in a monitored account which match
one of our metric definitions, health monitoring is automatically
set up.

By tagging the resources with a `Service` we can group component
resources into a definition of the health status for a whole service.

## Lambda / python

### Generate Metric Alarms
This has been written as a lambda but potentially it could be run locally
by the concourse pipeline.

[README.md](lambda/health_package/README.md)

### Health Monitor
This lambda subscribes to an SNS health topic and routes the alarm to
appropriate notification SNS topics.

[README.md](lambda/health_package/README.md)

## Terraform

There are a number of deployments in `terraform/deployments`

### [account_id]

These deployments define the cloudwatch alarms and the cloudwatch
forwarder lambdas. Alarms, metrics and events are all forwarded
cross-account to either the prod or non-prod health monitors via
an SQS queue.

The alarm config is generated by `generate_metric_alarms.py` as above.

The terraform needs to be applied with the `alarms.tfvars` var file.
The file should be generated into the terraform deployments folder.

```
terraform apply --var-file=alarms.tfvars
```

Without the alarms file all cloudwatch alarms will be destroyed.

### [account_id]_health_monitor

The health monitor defines the lambdas that deal with the health event
data - forward it to slack and splunk and the queues and sns topics.

### [account_id]_pipeline

There is also a deployment for the codepipeline deployment

## Docker

There are 2 Dockerfiles:
1. terraform-container - [README.md](docker/concourse-worker-health/README.md)
    Installs a specified version of terraform and contains scripts
    to perform an STS:AssumeRole operation to assume the role for
    a given pipeline.

2. http-api-container - [README.md](docker/http-api-resource/README.md)
    Replaces the standard `aequitas/http-api-resource` container
    kernel with a more recent version to patch vulnerabilities.
